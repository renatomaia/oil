<%
local Reference = {
	oil = {
		init = {
			parameters = "[config]",
			results = "orb",
			summary = "Initialize a broker",
			description = {
[[Initialize a broker or ORB instance on table <code>config</code> using its fields as configuration options.
The actual configuration options varies accordingly to the ]]..link("Flavors","ORB flavor")..[[.
For more information, see section ]]..link("Brokers")..[[.]],

[[The returned value is the same table <code>config</code> now containing an initialized ORB and all values of the configuration options used, including default values adopted.
This returned table implements the <a href="#orb">ORB interface</a> and shall not be modified by the application.]],

[[If parameter <code>config</code> already contains an initialized ORB, this function have no effect and only returns table <code>config</code> unmodified.
All calls of this function without parameter <code>config</code> returns the same ORB, which is initialized with default configuration options.
To create different ORBs with the default configuration, pass a different empty table as parameter <code>config</code>.]],
			},
			examples = {
[[orb = oil.init{ host="orb.tecgraf.puc-rio.br" }]],
[[oil.init{ host="10.223.10.56", port=2089 }:run()]],
[[print("Default port chosen:", oil.init().port)]],
			},
		},
		main = {
			parameters = "func [, ...]",
			results = "...",
			summary = "Runs code with multhreading support, if available",
			description = {
[[The application's main function is executed in a new thread if the current assembly provides thread support.
This function only returns when the application terminates.]],
			},
			examples = {
[[oil.main(function() oil.init():run() end)]],
			},
		},
		newthread = {
			parameters = "func [, ...]",
			results = "thread",
			summary = "Creates and starts the execution of a new the thread",
			description = {
[[Creates a new thread to execute the function <code>func</code> with the extra parameters provided.
This function immediately starts the execution of the new thread.
The original thread will be resumed again accordingly to the the scheduler's internal policy.
This function can only be invoked from others threads, including the one executing the application's main function (see <code>main</code>).]],
			},
		},
	},
	
	orb = { "object",
		pending = {
			parameters = "",
			results = "",
			summary = "",
			description = {
[[
]],
			},
		},
	},
}

local sorted do
	local function iterator(next, last)
		local key = next[last]
		return key, next.map[key]
	end
	function sorted(map, comp)
		local keys = {}
		for key in pairs(map) do
			if type(key) == "string" then
				keys[#keys+1] = key
			end
		end
		table.sort(keys, comp)
		local next = {map=map}
		local last = next
		for _, key in ipairs(keys) do
			next[last] = key
			last = key
		end
		return iterator, next, next
	end
end

local index = {level=0}
local contents = {level=0}

local function out(output, text, ...)
	local ident = ""
	local inc = ...
	if select("#", ...) == 0 then inc = 0 end
	if inc ~= nil then
		if inc < 0 then output.level = output.level+inc end
		ident = string.rep("\t", output.level)
		if inc > 0 then output.level = output.level+inc end
	end
	output[#output+1] = ident
	output[#output+1] = text:gsub("\n", "\n"..ident)
	output[#output+1] = "\n"
end

out(index, '<table>', 1)
for name, ref in sorted(Reference) do
	out(contents, '<h3>'..name..'</h3>')
	out(contents, '<dl>', 1)
	local sep = (ref[1] == "object") and ":" or "."
	for field, desc in sorted(ref) do
		local id = name..sep..field

		out(index, '<tr>', 1)
		out(index, '<td><a href="#'..id..'"><code>'..id..'</code></a></td>')
		out(index, '<td>'..(desc.summary or "")..'</td>')
		out(index, '</tr>', -1)

		local parameters = desc.parameters or ""
		local results = desc.results or ""
		if results ~= "" then
			results = "<code>"..results.." = </code>"
		end
		out(contents, '<dt>'..results..'<a name="'..id..'"><code>'..id..'</code></a><code>('..parameters..')</code></dt>')
		out(contents, '<dd>', 1)
		local description = desc.description
		if description ~= nil then
			for _, paragraph in ipairs(description) do
				out(contents, '<p>'..paragraph..'</p>')
			end
		end
		local examples = desc.examples
		if examples ~= nil then
			out(contents, '<p>Example:</p>')
			out(contents, '')
			for _, example in ipairs(examples) do
				out(contents, '<pre>'..example..'</pre>', nil)
			end
			out(contents, '')
		end
		out(contents, '</dd>', -1)
	end
	out(contents, '</dl>', -1)
end
out(index, '</table>', -1)

return table.concat(index).."\n<hr>\n"..table.concat(contents)
%>

<hr>
<hr>
<hr>
<hr>
<hr>

<h3>Definitions</h3>
<dl>
	<dt><a name="newthread"><b><code>oil.newthread</code></b></a><code>(func, ...)</code></dt>
	<dd>
	<p>
		<b>.</b>
		<br>
	<p>
		<i>Parameters:</i>
		<table>
		<tr>
			<td valign="top"><code>func</code></td>
			<td valign="top"><b>function</b></td>
			<td valign="top"></td>
			<td>Function that the new thread will execute.</td>
		</tr>
		<tr>
			<td valign="top"><code>...</code></td>
			<td valign="top"><b>any</b></td>
			<td valign="top"></td>
			<td>Additional parameters passed to the <code>func</code> function.</td>
		</tr>
		</table>
	<p>
		<i>Usage:</i>
		<pre>
oil.newthread(broker.run, broker) -- runs in another thread
		</pre>
	<p>
		<i>See also:</i> <a href="#main"><b><code>oil.main</code></b></a>
	</dd>
	
	<dt><a name="sleep"><b><code>oil.sleep</code></b></a><code>(time)</code></dt>
	<dd>
	<p>
		<b>Suspends the execution of the current thread for at least <code>time</code> seconds.</b>
	<p>
		<i>Parameters:</i>
		<table>
		<tr>
			<td valign="top"><code>time</code></td>
			<td valign="top"><b>number</b></td>
			<td valign="top"></td>
			<td>Time in seconds that the current thread must be suspended.</td>
		</tr>
		</table>
	<p>
		<i>Usage:</i>
		<pre>
oil.sleep(5.5)
		</pre>
	</dd>
	
	<dt><a name="time"><b><code>oil.time</code></b></a><code>()</code></dt>
	<dd>
	<p>
		<b>Get the current time of the system.</b>
	<p>
		<i>Return values:</i>
		<table>
		<tr>
			<td valign="top"><code>timestamp</code></td>
			<td valign="top"><b>number</b></td>
			<td valign="top"></td>
			<td>Number of seconds since a fixed point in the past.</td>
		</tr>
		</table>
	<p>
		<i>Usage:</i>
		<pre>
local start = oil.time(); oil.sleep(3); print("I slept for", oil.time() - start)
		</pre>
	</dd>
	
	<dt><a name="writeto"><b><code>oil.writeto</code></b></a><code>(filepath, text)</code></dt>
	<dd>
	<p>
		<b>Writes a text into file.</b>
		Utility function for writing stringfied IORs into a file.<br>
	<p>
		<i>Parameters:</i>
		<table>
		<tr>
			<td valign="top"><code>filepath</code></td>
			<td valign="top"><b>string</b></td>
			<td valign="top"></td>
			<td>Path of the file that should be create with the text provided.</td>
		</tr>
		<tr>
			<td valign="top"><code>text</code></td>
			<td valign="top"><b>string</b></td>
			<td valign="top"></td>
			<td>Text that shall be written into the file.</td>
		</tr>
		</table>
	<p>
		<i>Return values:</i>
		<table>
		<tr>
			<td valign="top"><code>success</code></td>
			<td valign="top"><b>file handler</b></td>
			<td valign="top"></td>
			<td>If the file was properly created with the provided content then the closed file handler is returned or <code>nil</code> is returned if some error was found.</td>
		</tr>
		<tr>
			<td valign="top"><code>error</code></td>
			<td valign="top"><b>string</b></td>
			<td valign="top">[occasional]</td>
			<td>Error message returned by function 'io.open' of Lua IO library if the file could not be opened for write.</td>
		</tr>
		</table>
	<p>
		<i>Usage:</i>
		<pre>
		</pre>
	</dd>
	
	<dt><a name="readfrom"><b><code>oil.readfrom</code></b></a><code>(filepath)</code></dt>
	<dd>
	<p>
		<b>Read the contents of a file.</b>
		Utility function for reading stringfied IORs from a file.<br>
	<p>
		<i>Parameters:</i>
		<table>
		<tr>
			<td valign="top"><code>success</code></td>
			<td valign="top"><b>file handler</b></td>
			<td valign="top"></td>
			<td>Path of the file to be read.</td>
		</tr>
		</table>
	<p>
		<i>Return values:</i>
		<table>
		<tr>
			<td valign="top"><code>contents</code></td>
			<td valign="top"><b>string</b></td>
			<td valign="top"></td>
			<td>Contents of the file read or <code>nil</code> if some error was found.</td>
		</tr>
		<tr>
			<td valign="top"><code>error</code></td>
			<td valign="top"><b>string</b></td>
			<td valign="top">[occasional]</td>
			<td>Error message returned by function 'io.open' of Lua IO library if the file could not be opened for read.</td>
		</tr>
		</table>
	</dd>
	
	<dt><a name="init"><b><code>oil.init</code></b></a><code>([config])</code></dt>
	<dd>
	<p>
		<b>Initialize a broker.</b>
		Initialize an ORB instance with the provided configuration.
		The actual configuration options varies accordingly to the <%=link("Flavors","ORB flavor")%>.
		For more information about broker initialization, see section <%=link"Brokers"%>.
		If the parameter <code>config</code> is not provided, the same ORB is returned, which is initialized with a default configuration.
		To create other ORBs with the default configuration, use an empty table as parameter <code>config</code>.<br>
	<p>
		<i>Parameters</i>
		<table>
		<tr>
			<td valign="top"><code>config</code></td>
			<td valign="top"><b>table</b></td>
			<td valign="top">[optional]</td>
			<td>Configuration used to initialize the ORB.</td>
		</tr>
		</table>
	<p>
		<i>Return values</i>
		<table>
		<tr>
			<td valign="top"><code>broker</code></td>
			<td valign="top"><b>table</b></td>
			<td valign="top"></td>
			<td>ORB instance properly initialized.</td>
		</tr>
		</table>
	<p>
		<i>Usage:</i>
		<pre>
oil.init{ host = "middleware.inf.puc-rio.br" }
oil.init{ host = "10.223.10.56", port = 8080 }
print("ORB port:", oil.init().port)
		</pre>
	</dd>
</dl>	
