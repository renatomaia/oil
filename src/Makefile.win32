# makefile for OiL libraries
# see INSTALL for installation instructions
# see ..\Makefile for further customization

!include ..\config.win32

PRECMP_LUA=	..\lua\precompiler.lua
PRELDR_LUA=	..\lua\preloader.lua

LOOP_PCK= $(addprefix ../lua/, \
	loop/base.lua \
	loop/cached.lua \
	loop/multiple.lua \
	loop/scoped.lua \
	loop/simple.lua \
	loop/table.lua \
	loop/collection/MapWithArrayOfKeys.lua \
	loop/collection/ObjectCache.lua \
	loop/collection/OrderedSet.lua \
	loop/collection/PriorityQueue.lua \
	loop/collection/UnorderedArray.lua \
	loop/collection/UnorderedArraySet.lua \
	loop/compiler/Arguments.lua \
	loop/compiler/Conditional.lua \
	loop/compiler/Expression.lua \
	loop/component/base.lua \
	loop/component/contained.lua \
	loop/component/dynamic.lua \
	loop/component/intercepted.lua \
	loop/component/wrapped.lua \
	loop/debug/Inspector.lua \
	loop/debug/Matcher.lua \
	loop/debug/Verbose.lua \
	loop/debug/Viewer.lua \
	loop/object/Exception.lua \
	loop/object/Wrapper.lua \
	loop/serial/FileStream.lua \
	loop/serial/Serializer.lua \
	loop/serial/SocketStream.lua \
	loop/serial/StringStream.lua \
	loop/thread/CoSocket.lua \
	loop/thread/IOScheduler.lua \
	loop/thread/Scheduler.lua \
	loop/thread/SocketScheduler.lua \
	loop/thread/Timer.lua \
)
LUAIDL_PCK= $(addprefix ../lua/, \
	luaidl/init.lua \
	luaidl/lex.lua \
	luaidl/pre.lua \
	luaidl/sin.lua \
)
OIL_PCK= $(addprefix ../lua/, \
	oil/assert.lua \
	oil/component.lua \
	oil/Exception.lua \
	oil/init.lua \
	oil/oo.lua \
	oil/port.lua \
	oil/properties.lua \
	oil/verbose.lua \
	oil/arch/base.lua \
	oil/arch/cooperative.lua \
	oil/arch/corba.lua \
	oil/arch/ludo.lua \
	oil/arch/typed.lua \
	oil/builder/base.lua \
	oil/builder/cooperative.lua \
	oil/builder/corba.lua \
	oil/builder/init.lua \
	oil/builder/ludo.lua \
	oil/builder/typed.lua \
	oil/corba/giop/Codec.lua \
	oil/corba/giop/Exception.lua \
	oil/corba/giop/Indexer.lua \
	oil/corba/giop/init.lua \
	oil/corba/giop/Listener.lua \
	oil/corba/giop/Messenger.lua \
	oil/corba/giop/ProxyOps.lua \
	oil/corba/giop/Referrer.lua \
	oil/corba/giop/Requester.lua \
	oil/corba/giop/ServantOps.lua \
	oil/corba/idl/Compiler.lua \
	oil/corba/idl/Importer.lua \
	oil/corba/idl/Indexer.lua \
	oil/corba/idl/init.lua \
	oil/corba/idl/ir.lua \
	oil/corba/idl/Registry.lua \
	oil/corba/idl/sysex.lua \
	oil/corba/iiop/Acceptor.lua \
	oil/corba/iiop/Connector.lua \
	oil/corba/iiop/Profiler.lua \
	oil/corba/interceptors/ClientSide.lua \
	oil/corba/interceptors/ServerSide.lua \
	oil/corba/services/event/Dispatcher.lua \
	oil/corba/services/event/Factory.lua \
	oil/corba/services/event/init.lua \
	oil/corba/services/event/Queue.lua \
	oil/corba/services/event/Reaper.lua \
	oil/corba/services/naming.lua \
	oil/kernel/base/Client.lua \
	oil/kernel/base/Dispatcher.lua \
	oil/kernel/base/Invoker.lua \
	oil/kernel/base/Proxies.lua \
	oil/kernel/base/Receiver.lua \
	oil/kernel/base/Server.lua \
	oil/kernel/base/Sockets.lua \
	oil/kernel/cooperative/Invoker.lua \
	oil/kernel/cooperative/Mutex.lua \
	oil/kernel/cooperative/Receiver.lua \
	oil/kernel/typed/Client.lua \
	oil/kernel/typed/Dispatcher.lua \
	oil/kernel/typed/Proxies.lua \
	oil/kernel/typed/Server.lua \
	oil/ludo/Codec.lua \
	oil/ludo/Listener.lua \
	oil/ludo/Referrer.lua \
	oil/ludo/Requester.lua \
)

OILBIT_INC=	oilbit.h
OILBIT_OBJ=	oilbit.obj
OILBIT_LIB=	oilbit.lib
OILBIT_EXT=	oilbit.dll oilbit.exp

PRECMP_INC=	loop.h luaidl.h oil.h
PRECMP_SRC=	loop.c luaidl.c oil.c
PRECMP_OBJ=	loop.obj luaidl.obj oil.obj
PRECMP_LIB=	loop.lib luaidl.lib oil.lib
PRECMP_EXT=	loop.dll luaidl.dll oil.dll \
          	loop.exp luaidl.exp oil.exp

PRELDR_INC=	oilall.h
PRELDR_SRC=	oilall.c
PRELDR_OBJ=	oilall.obj
PRELDR_LIB=	oilall.lib
PRELDR_EXT=	oilall.dll oilall.exp

OILBIN_OBJ=	console.obj
OILBIN_TRG=	console.exe

ALL_PRE=	$(PRECMP_INC) $(PRECMP_SRC) $(PRECMP_LIB) $(PRELDR_INC) $(PRELDR_SRC) $(PRELDR_LIB) $(OILBIN_TRG)
ALL_OBJ=	$(OILBIT_OBJ) $(PRECMP_OBJ) $(PRELDR_OBJ) $(OILBIN_OBJ)
ALL_TRG=	$(OILBIT_LIB)
ALL_LIB=	$(OILBIT_LIB)
ALL_EXT=	$(OILBIT_EXT) $(PRECMP_EXT) $(PRELDR_EXT)

all:	$(ALL_TRG) bundles preload

obj:	$(ALL_OBJ)

lib:	$(ALL_LIB)

loop.c loop.h: $(PRECMP_LUA) $(LOOP_PCK)
	$(LUA) $(PRECMP_LUA) $(PC_FLAGS) -o loop $(LOOP_PCK)

luaidl.c luaidl.h: $(PRECMP_LUA) $(LUAIDL_PCK)
	$(LUA) $(PRECMP_LUA) $(PC_FLAGS) -o luaidl $(LUAIDL_PCK)

oil.c oil.h: $(PRECMP_LUA) $(OIL_PCK)
	$(LUA) $(PRECMP_LUA) $(PC_FLAGS) -o oil $(OIL_PCK)

oilall.c oilall.h: $(PRELDR_LUA) $(PRECMP_INC) $(OILBIT_INC)
	$(LUA) $(PRELDR_LUA) $(PLD_FLAGS) -o oilall $(PRECMP_INC) $(OILBIT_INC)

$(OILBIT_LIB): $(OILBIT_OBJ)
	$(LINK) /$(LBT) $(LDFLAGS) /out:oilbit.$(LBT) $(OILBIT_OBJ) $(LIBS)

$(PRELDR_LIB): $(OILBIT_OBJ) $(PRECMP_OBJ) $(PRELDR_OBJ)
	$(LINK) /$(LBT) $(LDFLAGS) /out:oilall.$(LBT) $(OILBIT_OBJ) $(PRECMP_OBJ) $(PRELDR_OBJ) $(LIBS)

$(OILBIN_TRG): $(OILBIN_OBJ) $(PRELDR_LIB)
	$(LINK) $(LDFLAGS) /out:$@ $(OILBIN_OBJ) $(PRELDR_LIB) $(LIBS)

bundles: $(OILBIT_OBJ) $(PRECMP_OBJ)
	$(LINK) /$(LBT) $(LDFLAGS) /out:loop.$(LBT)             loop.obj $(LIBS)
	$(LINK) /$(LBT) $(LDFLAGS) /out:luaidl.$(LBT)         luaidl.obj $(LIBS)
	$(LINK) /$(LBT) $(LDFLAGS) /out:oil.$(LBT) $(OILBIT_OBJ) oil.obj $(LIBS)

preload: $(PRELDR_LIB)

console: $(OILBIN_TRG)

clean:
	$(RM) $(ALL_TRG) $(ALL_OBJ) $(ALL_EXT) $(ALL_PRE)

echo:
	@echo CC = $(CC)
	@echo LINK = $(LINK)
	@echo CFLAGS = $(CFLAGS)
	@echo LDFLAGS = $(LDFLAGS)
	@echo RM = $(RM)
	@echo MYCFLAGS = $(MYCFLAGS)
	@echo MYLDFLAGS = $(MYLDFLAGS)
	@echo MYLIBS = $(MYLIBS)

# convenience targets for usual platforms

none:
	@echo "Please choose a platform: $(PLATS)"

libs: all

dlls:
	$(MAKE) all LBT=dll LIBS="$(MYLIBS)" MYCFLAGS="/DOIL_API=__declspec(dllexport)"

# DO NOT DELETE

loop.obj: loop.c loop.h
luaidl.obj: luaidl.c luaidl.h
oilbit.obj: oilbit.c oilbit.h
oil.obj: oil.c oil.h
oilall.obj: $(PRECMP_INC) $(PRELDR_INC)
console.obj: $(PRELDR_INC) console-5.1.c console-5.0.2.c
