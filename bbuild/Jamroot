# -*- coding: iso-8859-1-unix -*-

import os ;
import modules ;

path-constant here : . ;
path-constant root : $(here)/.. ;
path-constant deps : $(root)/.. ;

local lua-jam-path = [ os.environ LUA_JAM_PATH ] ;
if ! $(lua-jam-path)
{
  lua-jam-path = "$(deps)/lua.jam" ;
}
use-project lua : $(lua-jam-path) ; 

local loop-root-path = [ os.environ LOOP_ROOT_PATH ] ;
if ! $(loop-root-path)
{
  loop-root-path = "$(deps)/loop" ;
}

modules.load preloader : : $(loop-root-path)/bbuild ;
import preloader ; 
using preloader ;

project oil
  : requirements
    <target-os>windows:<pch>off
    <target-os>windows,<link>shared:<runtime-link>shared
    <target-os>windows,<link>static:<runtime-link>static
    <target-os>windows:<debug-store>database
    <target-os>windows:<define>_CRT_SECURE_NO_WARNINGS
    <toolset>msvc-12.0:<cxxflags>/FS
    <debug-symbols>on
  ;

make oil.c
  :	$(root)/lua/oil/assert.lua
    $(root)/lua/oil/builder.lua
    $(root)/lua/oil/component.lua
    $(root)/lua/oil/corba/giop/Channel.lua
    $(root)/lua/oil/corba/giop/Channels.lua
    $(root)/lua/oil/corba/giop/Codec.lua
    $(root)/lua/oil/corba/giop/CodecGen.lua
    $(root)/lua/oil/corba/giop/Exception.lua
    $(root)/lua/oil/corba/giop/Indexer.lua
    $(root)/lua/oil/corba/giop/Listener.lua
    $(root)/lua/oil/corba/giop/Referrer.lua
    $(root)/lua/oil/corba/giop/Requester.lua
    $(root)/lua/oil/corba/giop.lua
    $(root)/lua/oil/corba/idl/Compiler.lua
    $(root)/lua/oil/corba/idl/Importer.lua
    $(root)/lua/oil/corba/idl/Indexer.lua
    $(root)/lua/oil/corba/idl/ir.lua
    $(root)/lua/oil/corba/idl/Registry.lua
    $(root)/lua/oil/corba/idl/sysex.lua
    $(root)/lua/oil/corba/idl.lua
    $(root)/lua/oil/corba/iiop/Profiler.lua
    $(root)/lua/oil/corba/iiop/ssl/ComponentCodec.lua
    $(root)/lua/oil/corba/intercepted/Listener.lua
    $(root)/lua/oil/corba/intercepted/Requester.lua
    $(root)/lua/oil/corba/intercepted/servicecontext.lua
    $(root)/lua/oil/corba/services/event/ConsumerAdmin.lua
    $(root)/lua/oil/corba/services/event/EventFactory.lua
    $(root)/lua/oil/corba/services/event/EventQueue.lua
    $(root)/lua/oil/corba/services/event/ProxyPushConsumer.lua
    $(root)/lua/oil/corba/services/event/ProxyPushSupplier.lua
    $(root)/lua/oil/corba/services/event/SingleDeferredDispatcher.lua
    $(root)/lua/oil/corba/services/event/SingleSynchronousDispatcher.lua
    $(root)/lua/oil/corba/services/event/SupplierAdmin.lua
    $(root)/lua/oil/corba/services/event.lua
    $(root)/lua/oil/corba/services/naming.lua
    $(root)/lua/oil/Exception.lua
    $(root)/lua/oil/kernel/base/Acceptor.lua
    $(root)/lua/oil/kernel/base/Channels.lua
    $(root)/lua/oil/kernel/base/Connector.lua
    $(root)/lua/oil/kernel/base/Dispatcher.lua
    $(root)/lua/oil/kernel/base/DNS.lua
    $(root)/lua/oil/kernel/base/Proxies/asynchronous.lua
    $(root)/lua/oil/kernel/base/Proxies/protected.lua
    $(root)/lua/oil/kernel/base/Proxies/synchronous.lua
    $(root)/lua/oil/kernel/base/Proxies/utils.lua
    $(root)/lua/oil/kernel/base/Limiter.lua
    $(root)/lua/oil/kernel/base/Proxies.lua
    $(root)/lua/oil/kernel/base/Receiver.lua
    $(root)/lua/oil/kernel/base/Servants.lua
    $(root)/lua/oil/kernel/base/Sockets.lua
    $(root)/lua/oil/kernel/cooperative/Connector.lua
    $(root)/lua/oil/kernel/cooperative/Receiver.lua
    $(root)/lua/oil/kernel/cooperative/SecureSockets.lua
    $(root)/lua/oil/kernel/cooperative/Sockets.lua
    $(root)/lua/oil/kernel/cooperative/Tasks.lua
    $(root)/lua/oil/kernel/intercepted/Listener.lua
    $(root)/lua/oil/kernel/intercepted/Requester.lua
    $(root)/lua/oil/kernel/lua/Dispatcher.lua
    $(root)/lua/oil/kernel/lua/Proxies.lua
    $(root)/lua/oil/kernel/typed/Dispatcher.lua
    $(root)/lua/oil/kernel/typed/Proxies.lua
    $(root)/lua/oil/kernel/typed/Servants.lua
    $(root)/lua/oil/ludo/Channel.lua
    $(root)/lua/oil/ludo/Codec.lua
    $(root)/lua/oil/ludo/CodecByRef.lua
    $(root)/lua/oil/ludo/Listener.lua
    $(root)/lua/oil/ludo/Referrer.lua
    $(root)/lua/oil/ludo/Requester.lua
    $(root)/lua/oil/oo.lua
    $(root)/lua/oil/port.lua
    $(root)/lua/oil/properties.lua
    $(root)/lua/oil/protocol/Channel.lua
    $(root)/lua/oil/protocol/Listener.lua
    $(root)/lua/oil/protocol/Request.lua
    $(root)/lua/oil/protocol/Requester.lua
    $(root)/lua/oil/verbose.lua
    $(root)/lua/oil.lua
  : preloader.pre-compile
  : <search>$(root)
    <location>$(here)
  ;

make luaidl.c
  :	$(root)/lua/luaidl/lex.lua
    $(root)/lua/luaidl/pre.lua
    $(root)/lua/luaidl/sin.lua
    $(root)/lua/luaidl.lua
  : preloader.pre-compile
  : <search>$(root)
    <location>$(here)
  ;

lib oil
  : oil.c
    /lua//lua
  : <target-os>windows,<link>shared:<linkflags>"/def:$(here)/oil.def"
    <include>src
  ;
explicit oil ;

lib luaidl
  : luaidl.c
    oil
    /lua//lua
  : <target-os>windows,<link>shared:<linkflags>"/def:$(here)/luaidl.def"
  :
  : <include>.
  ;
explicit luaidl ;

install stage
  : oil
    luaidl
  : <location>install
  ;
  